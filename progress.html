<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Training Diary with Smart Suggestions</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f0f4f8; font-family: system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif; }
    .hint { font-size: 0.75rem; color: #555; margin-top: 4px; }
    .suggestion { background: #e7f5ff; padding: 4px 8px; border-radius: 6px; display: inline-block; margin-right:6px; }
    .progress-up { color: #198754; font-weight:600; }
    .progress-down { color: #dc3545; font-weight:600; }
    .progress-same { color: #6c757d; }
    .small-table th, .small-table td { padding:4px; font-size:0.75rem; border:1px solid #ccc; }
    .cardio-history { background:#fff; border:1px solid #dee2e6; padding:6px; border-radius:6px; margin-bottom:6px; }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">
          <img src="images/logo1.png" alt="Training Diary Logo" width="100" height="100">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="index.html">Workout Log</a></li>
            <li class="nav-item"><a class="nav-link active" href="progress.html">Progress</a></li>
            <li class="nav-item"><a class="nav-link" href="photo_progress.html">Photo Progress</a></li>
            <li class="nav-item"><a class="nav-link" href="calculators.html">Calculators</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <h2 class="mb-3">Smart Strength & Cardio Training Diary</h2>

    <form id="trainingForm" class="mb-5">
      <div class="row g-4">
        <div class="col-md-4">
          <label for="dateInput" class="form-label fw-bold">Date</label>
          <input type="date" id="dateInput" class="form-control" required>
        </div>
        <div class="col-md-8">
          <label class="form-label fw-bold d-block">&nbsp;</label>
          <div id="dailyGoals" class="d-flex gap-3">
            <div class="badge bg-info text-dark">Goal: ≥3 strength sessions/week</div>
            <div class="badge bg-info text-dark">Goal: ≥10,000 steps/day</div>
          </div>
        </div>
      </div>

      <hr>

      <!-- Cardio Section -->
      <div class="mb-4">
        <h5>Cardio Training</h5>
        <div id="cardioContainer">
          <div class="card mb-3 p-3">
            <div class="row g-2 align-items-end cardio-row">
              <div class="col-md-3">
                <label class="form-label">Activity</label>
                <select class="form-select cardio-activity">
                  <option value="">Select...</option>
                  <option value="Running">Running</option>
                  <option value="Walking">Walking</option>
                  <option value="Biking">Biking</option>
                  <option value="Skiing">Skiing</option>
                  <option value="Elliptical">Elliptical</option>
                  <option value="Other">Other</option>
                </select>
                <input type="text" class="form-control mt-1 cardio-other" placeholder="Specify activity" style="display:none;">
              </div>
              <div class="col-md-2">
                <label class="form-label">Time (min)</label>
                <input type="number" step="1" class="form-control cardio-time" placeholder="30">
              </div>
              <div class="col-md-2">
                <label class="form-label">Distance (km)</label>
                <input type="number" step="0.1" class="form-control cardio-distance" placeholder="5">
              </div>
              <div class="col-md-2">
                <label class="form-label">Avg Speed (km/h)</label>
                <input type="number" step="0.1" class="form-control cardio-speed" placeholder="10">
              </div>
              <div class="col-md-2">
                <label class="form-label">Steps</label>
                <input type="number" class="form-control cardio-steps" placeholder="6000">
              </div>
              <div class="col-md-1 text-end">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="removeCardioRow(this)">✕</button>
              </div>
              <div class="col-12">
                <div class="hint cardio-hint">История и предложение появятся после выбора активности.</div>
              </div>
            </div>
          </div>
        </div>
        <button type="button" class="btn btn-secondary btn-sm" onclick="addCardioRow()">Add Cardio</button>
      </div>

      <hr>
 <!-- Joint Mobility -->
      <div class="mb-3">
        <label class="form-label">Joint Mobility</label>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="joint">
          <label class="form-check-label" for="joint">Done</label>
          <button type="button" class="btn btn-link btn-sm" onclick="toggleJointInfo()">What is it?</button>
        </div>
        <div id="jointInfo" class="mt-2 text-muted" style="display: none; font-size: 0.9em;">
          Joint mobility is a warm-up for joints (neck, shoulders, hips, knees, etc.), helps prevent injuries, improves mobility, and is performed at the beginning of a workout.
          <br>
          <em>Joint mobility is a warm-up for joints (neck, shoulders, hips, knees, etc.).</em>
        </div>
      </div>

      <hr>
      <!-- Strength Section -->
      <div class="mb-4">
        <h5>Strength Workout</h5>
        <table class="table table-bordered" id="strengthTable">
          <thead>
            <tr>
              <th style="min-width:150px;">Exercise</th>
              <th>Sets</th>
              <th>Reps</th>
              <th>Weight (kg)</th>
              <th>Next Suggestion</th>
              <th>Note</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="workoutBody">
            <datalist id="exerciseOptions"></datalist>
            <tr class="strength-row">
              <td>
                <div class="d-flex flex-column">
                  <input list="exerciseOptions" type="text" class="form-control exercise-name" placeholder="Barbell Squat" />
                  <input type="text" class="form-control mt-1 exercise-other" placeholder="Specify exercise" style="display:none;" />
                  <div class="hint exercise-history">История: —</div>
                </div>
              </td>
              <td><input type="number" class="form-control" placeholder="3"></td>
              <td><input type="number" class="form-control" placeholder="10"></td>
              <td><input type="number" class="form-control weight-input" placeholder="50"></td>
              <td class="suggestion-cell">
                <div class="suggestion" style="display:none;">Следующий: <span class="suggested-weight"></span> kg</div>
              </td>
              <td><input type="text" class="form-control" placeholder="Note"></td>
              <td><button type="button" class="btn btn-outline-secondary btn-sm" onclick="removeStrengthRow(this)">✕</button></td>
            </tr>
          </tbody>
        </table>
        <button type="button" class="btn btn-secondary mb-2" onclick="addRow()">Add Exercise</button>
      </div>

      <!-- Reflection -->
      <div class="mb-3">
        <label for="notes" class="form-label">Reflection / Next Goal</label>
        <textarea id="notes" class="form-control" rows="2"></textarea>
      </div>

      <button type="submit" class="btn btn-primary">Save Entry</button>
    </form>

    <!-- Entries -->
    <div class="mb-5">
      <hr>
      <div class="d-flex justify-content-between mb-2">
        <h4>Diary Entries</h4>
        <button class="btn btn-success btn-sm" onclick="exportAllEntriesPDF()">Export All with Progression PDF</button>
      </div>
      <div id="entriesList" class="list-group"></div>
    </div>
  </div>

  <!-- Modal preview -->
  <div class="modal fade" id="entryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Workout Entry & Progression</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="entryPreview" style="background:#fff;"></div>
        <div class="modal-footer">
          <button class="btn btn-outline-primary" onclick="printEntry()">Print</button>
          <button class="btn btn-outline-secondary" onclick="downloadEntryPDF()">Download PDF</button>
          <button class="btn btn-danger" id="deleteEntryBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // список силовых упражнений (compound + isolation + Other)
    const exerciseList = [
      "Barbell Back Squat", "Barbell Front Squat", "Deadlift", "Romanian Deadlift", "Bench Press",
      "Incline Bench Press", "Overhead Press", "Pull-up", "Chin-up", "Bent-over Row", "Dumbbell Row",
      "Hip Thrust", "Lunges", "Leg Press", "Bulgarian Split Squat", "Dips", "Push-up", "Cable Fly",
      "Face Pull", "Bicep Curl", "Tricep Extension", "Calf Raise", "Plank", "Russian Twist",
      "Glute Bridge", "Renegade Row", "Thruster", "Skull Crusher", "Lat Pulldown", "Chest Fly",
      "Single-leg Deadlift", "Farmer's Carry", "Chest Dip", "Shoulder Lateral Raise", "Other"
    ];

    // Storage key
    const STORAGE_KEY = 'trainingDiaryEntries';

    // Utility
    function loadEntries() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }
    function persistEntries(arr) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }
    function saveEntry(entry) {
      const entries = loadEntries();
      const idx = entries.findIndex(e => e.id === entry.id);
      if (idx !== -1) entries[idx] = entry;
      else entries.unshift(entry);
      persistEntries(entries);
    }
    function deleteEntry(id) {
      let entries = loadEntries();
      entries = entries.filter(e => e.id !== id);
      persistEntries(entries);
      renderEntriesList();
    }

    // BMI helper
    function calculateBmi(weight, heightM) {
      if (!weight || !heightM) return { value: null, interpretation: '—' };
      const bmi = weight / (heightM * heightM);
      let interpretation = '';
      if (bmi < 18.5) interpretation = 'Underweight';
      else if (bmi < 25) interpretation = 'Normal weight';
      else if (bmi < 30) interpretation = 'Overweight';
      else interpretation = 'Obesity';
      return { value: bmi, interpretation };
    }

    // Strength history & suggestion
    function getHistoryForExercise(name) {
      if (!name) return [];
      const entries = loadEntries().sort((a,b)=> new Date(a.savedAt) - new Date(b.savedAt));
      const hist = [];
      entries.forEach(e => {
        (e.strength || []).forEach(s => {
          if ((s.exercise||'').trim().toLowerCase() === name.trim().toLowerCase()) {
            const w = parseFloat(s.weight);
            if (!isNaN(w)) hist.push({ weight: w, date: e.date });
          }
        });
      });
      return hist.slice(-3);
    }
    function computeSuggestedWeight(history) {
      if (history.length === 0) return null;
      if (history.length === 1) return (history[0].weight + 2.5).toFixed(1);
      const deltas = [];
      for (let i = 1; i < history.length; i++) {
        deltas.push(history[i].weight - history[i-1].weight);
      }
      const avgDelta = deltas.reduce((a,b)=>a+b,0)/deltas.length;
      const last = history[history.length-1].weight;
      return (last + avgDelta).toFixed(1);
    }

    // Cardio history & suggestion
    function getCardioHistoryForActivity(activity) {
      if (!activity) return [];
      const entries = loadEntries().sort((a,b)=> new Date(b.savedAt) - new Date(a.savedAt));
      const hist = [];
      for (const e of entries) {
        (e.cardio || []).forEach(c => {
          if ((c.activity||'').trim().toLowerCase() === activity.trim().toLowerCase()) {
            hist.push({
              time: parseFloat(c.time) || 0,
              distance: parseFloat(c.distance) || 0,
              speed: parseFloat(c.avgSpeed) || 0,
              steps: parseInt(c.steps) || 0,
              date: e.date
            });
          }
        });
      }
      return hist.slice(0,3);
    }
    function suggestCardioProgress(hist) {
      if (hist.length === 0) return null;
      const latest = hist[0];
      return {
        time: latest.time ? (latest.time * 1.05).toFixed(1) : null,
        distance: latest.distance ? (latest.distance * 1.05).toFixed(2) : null,
        speed: latest.speed ? (latest.speed * 1.05).toFixed(2) : null,
        steps: latest.steps ? Math.ceil(latest.steps * 1.05) : null
      };
    }

    // Populate datalist
    function populateExerciseDatalist() {
      const dl = document.getElementById('exerciseOptions');
      if (!dl) return;
      dl.innerHTML = '';
      exerciseList.forEach(ex => {
        const opt = document.createElement('option');
        opt.value = ex;
        dl.appendChild(opt);
      });
    }

    // Wire "Other" logic
    function wireExerciseNameField(row) {
      const nameInput = row.querySelector('.exercise-name');
      const otherInput = row.querySelector('.exercise-other');
      nameInput.addEventListener('input', () => {
        if (nameInput.value.trim().toLowerCase() === 'other') {
          otherInput.style.display = 'block';
          otherInput.focus();
        } else {
          otherInput.style.display = 'none';
          otherInput.value = '';
        }
      });
    }

    // Strength row listener (merged, handles Other)
    function attachStrengthRowListeners(row) {
      const nameInput = row.querySelector('.exercise-name');
      const weightInput = row.querySelector('.weight-input');
      const historyDiv = row.querySelector('.exercise-history');
      const suggestionBox = row.querySelector('.suggestion');
      const suggestedWeightSpan = row.querySelector('.suggested-weight');
      const otherInput = row.querySelector('.exercise-other');

      function getEffectiveName() {
        if (nameInput.value.trim().toLowerCase() === 'other' && otherInput && otherInput.value.trim()) {
          return otherInput.value.trim();
        }
        return nameInput.value.trim();
      }

      function updateHint() {
        const name = getEffectiveName();
        if (!name) {
          historyDiv.textContent = 'История: —';
          suggestionBox.style.display = 'none';
          return;
        }
        const hist = getHistoryForExercise(name);
        if (hist.length === 0) {
          historyDiv.textContent = 'История: нет данных';
        } else {
          const list = hist.map(h => `${h.weight.toFixed(1)} kg (${h.date})`).join(' → ');
          historyDiv.textContent = `История: ${list}`;
        }
        const suggested = computeSuggestedWeight(hist);
        if (suggested) {
          suggestedWeightSpan.textContent = suggested;
          suggestionBox.style.display = 'inline-block';
        } else {
          suggestionBox.style.display = 'none';
        }
      }

      nameInput.addEventListener('input', () => {
        if (nameInput.value.trim().toLowerCase() === 'other') {
          if (otherInput) otherInput.style.display = 'block';
        } else {
          if (otherInput) {
            otherInput.style.display = 'none';
            otherInput.value = '';
          }
        }
        updateHint();
      });
      if (otherInput) {
        otherInput.addEventListener('input', updateHint);
      }
      weightInput.addEventListener('focus', updateHint);
      updateHint();
    }

    // Cardio row listeners
    function attachCardioRowListeners(cardioRow) {
      const activitySelect = cardioRow.querySelector('.cardio-activity');
      const otherInput = cardioRow.querySelector('.cardio-other');
      const hintDiv = cardioRow.querySelector('.cardio-hint');

      function updateCardioHint() {
        let activity = activitySelect.value;
        if (activity === 'Other') activity = otherInput.value.trim();
        if (!activity) {
          hintDiv.textContent = 'История и предложение появятся после выбора активности.';
          return;
        }
        const hist = getCardioHistoryForActivity(activity);
        const suggestion = suggestCardioProgress(hist);
        let html = '';
        if (hist.length) {
          html += `<div class="cardio-history"><strong>Последние записи (${activity}):</strong>`;
          hist.forEach(h => {
            html += `<div style="margin-top:2px;">${h.date}: time ${h.time || '—'} min, dist ${h.distance || '—'} km, speed ${h.speed || '—'} km/h, steps ${h.steps || '—'}</div>`;
          });
          html += `</div>`;
        } else {
          html += `<div class="cardio-history"><em>Нет предыдущих данных по “${activity}”.</em></div>`;
        }
        if (suggestion) {
          html += `<div class="suggestion">Рекомендация: `;
          const parts = [];
          if (suggestion.distance) parts.push(`distance ≈ ${suggestion.distance} km`);
          if (suggestion.time) parts.push(`time ≈ ${suggestion.time} min`);
          if (suggestion.speed) parts.push(`speed ≈ ${suggestion.speed} km/h`);
          if (suggestion.steps) parts.push(`steps ≈ ${suggestion.steps}`);
          html += parts.join(', ');
          html += `</div>`;
        }
        hintDiv.innerHTML = html;
      }

      activitySelect.addEventListener('change', () => {
        if (activitySelect.value === 'Other') {
          otherInput.style.display = 'block';
        } else {
          otherInput.style.display = 'none';
          otherInput.value = '';
        }
        updateCardioHint();
      });
      otherInput.addEventListener('input', updateCardioHint);
      updateCardioHint();
    }

    // Row operations
    function addRow() {
      const tbody = document.getElementById('workoutBody');
      const tr = document.createElement('tr');
      tr.className = 'strength-row';
      tr.innerHTML = `
        <td>
          <div class="d-flex flex-column">
            <input list="exerciseOptions" type="text" class="form-control exercise-name" placeholder="Exercise" />
            <input type="text" class="form-control mt-1 exercise-other" placeholder="Specify exercise" style="display:none;" />
            <div class="hint exercise-history">История: —</div>
          </div>
        </td>
        <td><input type="number" class="form-control" placeholder="Sets"></td>
        <td><input type="number" class="form-control" placeholder="Reps"></td>
        <td><input type="number" class="form-control weight-input" placeholder="Weight"></td>
        <td class="suggestion-cell">
          <div class="suggestion" style="display:none;">Следующий: <span class="suggested-weight"></span> kg</div>
        </td>
        <td><input type="text" class="form-control" placeholder="Note"></td>
        <td><button type="button" class="btn btn-outline-secondary btn-sm" onclick="removeStrengthRow(this)">✕</button></td>
      `;
      tbody.appendChild(tr);
      wireExerciseNameField(tr);
      attachStrengthRowListeners(tr);
    }
    function removeStrengthRow(btn) {
      const tr = btn.closest('tr');
      tr.remove();
    }
    function addCardioRow() {
      const container = document.getElementById('cardioContainer');
      const wrapper = document.createElement('div');
      wrapper.className = 'card mb-3 p-3';
      wrapper.innerHTML = `
        <div class="row g-2 align-items-end cardio-row">
          <div class="col-md-3">
            <label class="form-label">Activity</label>
            <select class="form-select cardio-activity">
              <option value="">Select...</option>
              <option value="Running">Running</option>
              <option value="Walking">Walking</option>
              <option value="Biking">Biking</option>
              <option value="Skiing">Skiing</option>
              <option value="Elliptical">Elliptical</option>
              <option value="Other">Other</option>
            </select>
            <input type="text" class="form-control mt-1 cardio-other" placeholder="Specify activity" style="display:none;">
          </div>
          <div class="col-md-2">
            <label class="form-label">Time (min)</label>
            <input type="number" step="1" class="form-control cardio-time" placeholder="30">
          </div>
          <div class="col-md-2">
            <label class="form-label">Distance (km)</label>
            <input type="number" step="0.1" class="form-control cardio-distance" placeholder="5">
          </div>
          <div class="col-md-2">
            <label class="form-label">Avg Speed (km/h)</label>
            <input type="number" step="0.1" class="form-control cardio-speed" placeholder="10">
          </div>
          <div class="col-md-2">
            <label class="form-label">Steps</label>
            <input type="number" class="form-control cardio-steps" placeholder="6000">
          </div>
          <div class="col-md-1 text-end">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="removeCardioRow(this)">✕</button>
          </div>
          <div class="col-12">
            <div class="hint cardio-hint">История и предложение появятся после выбора активности.</div>
          </div>
        </div>
      `;
      container.appendChild(wrapper);
      const row = wrapper.querySelector('.cardio-row');
      attachCardioRowListeners(row);
    }
    function removeCardioRow(btn) {
      const card = btn.closest('.card');
      card.remove();
    }

    // Form entry collection (including measurements & photo from previous storage)
    function collectFormEntry() {
      const date = document.getElementById('dateInput').value || new Date().toISOString().slice(0,10);
      const cardioRows = Array.from(document.querySelectorAll('.cardio-row')).map(row => {
        let activity = row.querySelector('.cardio-activity').value;
        if (activity === 'Other') activity = row.querySelector('.cardio-other').value;
        return {
          activity: activity || '',
          time: row.querySelector('.cardio-time')?.value,
          distance: row.querySelector('.cardio-distance')?.value,
          avgSpeed: row.querySelector('.cardio-speed')?.value,
          steps: row.querySelector('.cardio-steps')?.value
        };
      });
      const strengthRows = Array.from(document.querySelectorAll('.strength-row')).map(row => {
        let name = row.querySelector('.exercise-name')?.value || '';
        const other = row.querySelector('.exercise-other')?.value;
        if (name.trim().toLowerCase() === 'other' && other) name = other;
        return {
          exercise: name,
          sets: row.querySelector('td:nth-child(2) input')?.value,
          reps: row.querySelector('td:nth-child(3) input')?.value,
          weight: row.querySelector('.weight-input')?.value,
          note: row.querySelector('td:nth-child(6) input')?.value
        };
      });
      const reflection = document.getElementById('notes').value;
      const timestamp = new Date().toISOString();

      const measurements = JSON.parse(localStorage.getItem('bodyMeasurements') || '[]');
      const measurementForDate = measurements.find(m => m.date === date) || null;

      const photos = JSON.parse(localStorage.getItem('progressPhotos') || '[]');
      const photoForDate = photos.find(p => p.date === date) || null;

      return {
        id: 'entry_' + timestamp,
        date,
        cardio: cardioRows,
        strength: strengthRows,
        reflection,
        measurement: measurementForDate,
        photo: photoForDate,
        savedAt: timestamp
      };
    }

    // Rendering list
    function renderEntriesList() {
      const list = document.getElementById('entriesList');
      list.innerHTML = '';
      const entries = loadEntries();
      if (!entries.length) {
        list.innerHTML = '<div class="text-muted">No entries yet.</div>';
        return;
      }
      entries.forEach(entry => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center flex-wrap';
        const left = document.createElement('div');
        left.innerHTML = `<div><strong>${entry.date}</strong> — saved: ${new Date(entry.savedAt).toLocaleString()}</div>
          <div class="small text-muted">Strength: ${entry.strength.length}, Cardio: ${entry.cardio?.length||0}</div>`;
        const btns = document.createElement('div');
        btns.className = 'btn-group btn-group-sm';
        const view = document.createElement('button');
        view.className = 'btn btn-outline-primary';
        view.textContent = 'View';
        view.onclick = () => openEntryModal(entry);
        const pdf = document.createElement('button');
        pdf.className = 'btn btn-outline-success';
        pdf.textContent = 'PDF';
        pdf.onclick = () => exportEntryPDF(entry);
        const del = document.createElement('button');
        del.className = 'btn btn-outline-danger';
        del.textContent = 'Delete';
        del.onclick = () => {
          if (confirm('Delete entry?')) deleteEntry(entry.id);
        };
        btns.append(view, pdf, del);
        item.append(left, btns);
        list.appendChild(item);
      });
    }

    // Progression section for an entry
    function buildProgressionSection(entry) {
      const prevEntries = loadEntries()
        .filter(e => new Date(e.savedAt) < new Date(entry.savedAt))
        .sort((a,b)=> new Date(b.savedAt)-new Date(a.savedAt))
        .slice(0,2);
      if (prevEntries.length === 0) {
        return '<div><em>No prior entries to compute progression.</em></div>';
      }
      const rows = (entry.strength || []).map(s => {
        const name = (s.exercise||'').trim() || '—';
        const current = parseFloat(s.weight) || 0;
        const hist = [];
        prevEntries.slice().reverse().forEach(pe => {
          const match = (pe.strength || []).find(x => (x.exercise||'').trim().toLowerCase() === name.toLowerCase());
          if (match) {
            const w = parseFloat(match.weight);
            if (!isNaN(w)) hist.push({ weight: w, date: pe.date });
          }
        });
        const sequence = [...hist, { weight: current, date: entry.date }];
        let deltaText = '—';
        if (sequence.length >=2) {
          const prevWeight = sequence[sequence.length-2].weight;
          const delta = current - prevWeight;
          if (delta > 0) deltaText = `<span class="progress-up">+${delta.toFixed(1)} kg</span>`;
          else if (delta < 0) deltaText = `<span class="progress-down">${delta.toFixed(1)} kg</span>`;
          else deltaText = `<span class="progress-same">0</span>`;
        }
        let trend = '';
        if (sequence.length === 3) {
          const first = sequence[0].weight;
          const last = sequence[2].weight;
          const tot = last - first;
          if (tot > 0) trend = `<span class="progress-up">+${tot.toFixed(1)} kg over 3</span>`;
          else if (tot < 0) trend = `<span class="progress-down">${tot.toFixed(1)} kg over 3</span>`;
          else trend = `<span class="progress-same">no change</span>`;
        }
        return `
          <tr>
            <td>${name}</td>
            <td style="text-align:center;">${current.toFixed(1)} kg</td>
            <td style="text-align:center;">${deltaText}</td>
            <td style="text-align:center;">${trend || '—'}</td>
          </tr>
        `;
      }).join('');
      return `
        <div class="mb-3">
          <h5>Strength Progression (last 3 entries)</h5>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Exercise</th>
                <th>Current Weight</th>
                <th>Δ from previous</th>
                <th>Trend</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    // Build entry HTML including measurements & photo
    function buildEntryHTML(entry) {
      const progSection = buildProgressionSection(entry);
      const meas = entry.measurement || {};
      const heightCm = localStorage.getItem('userHeight');
      const heightM = heightCm ? parseFloat(heightCm)/100 : null;
      const bmiObj = meas.weight && heightM ? calculateBmi(meas.weight, heightM) : { value: null, interpretation: '—' };

      let photoHtml = '<div><em>No photo for this entry.</em></div>';
      if (entry.photo && entry.photo.src) {
        photoHtml = `
          <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
            <div style="flex:1; min-width:200px;">
              <div><strong>Photo (${entry.photo.date})</strong></div>
              <div style="border:1px solid #ccc; padding:6px; border-radius:6px; background:#f8f9fa;">
                <img src="${entry.photo.src}" style="max-width:100%; height:auto; display:block;" alt="Photo ${entry.photo.date}">
              </div>
            </div>
          </div>
        `;
      }

      const container = document.createElement('div');
      container.style.padding = '16px';
      container.style.background = '#fff';
      container.style.color = '#222';
      container.innerHTML = `
        <div style="margin-bottom:8px;">
          <h2 style="margin:0;">Workout Diary</h2>
          <div><strong>Date:</strong> ${entry.date}</div>
          <div><strong>Saved at:</strong> ${new Date(entry.savedAt).toLocaleString()}</div>
        </div>
        ${progSection}
        <div style="margin-bottom:12px;">
          <h5>Measurements</h5>
          <table style="border-collapse:collapse; width:100%; font-size:0.9em;">
            <tr>
              <td style="border:1px solid #bbb; padding:6px;"><strong>Weight</strong></td>
              <td style="border:1px solid #bbb; padding:6px;">${meas.weight != null ? meas.weight + ' kg' : '—'}</td>
              <td style="border:1px solid #bbb; padding:6px;"><strong>BMI</strong></td>
              <td style="border:1px solid #bbb; padding:6px;">${bmiObj.value ? bmiObj.value.toFixed(1) : '—'} (${bmiObj.interpretation})</td>
            </tr>
            <tr>
              <td style="border:1px solid #bbb; padding:6px;"><strong>Waist</strong></td>
              <td style="border:1px solid #bbb; padding:6px;">${meas.waist != null ? meas.waist + ' cm' : '—'}</td>
              <td style="border:1px solid #bbb; padding:6px;"><strong>Hips</strong></td>
              <td style="border:1px solid #bbb; padding:6px;">${meas.hips != null ? meas.hips + ' cm' : '—'}</td>
            </tr>
            <tr>
              <td style="border:1px solid #bbb; padding:6px;"><strong>Chest</strong></td>
              <td style="border:1px solid #bbb; padding:6px;">${meas.chest != null ? meas.chest + ' cm' : '—'}</td>
              <td style="border:1px solid #bbb; padding:6px;"><strong>Biceps</strong></td>
              <td style="border:1px solid #bbb; padding:6px;">${meas.biceps != null ? meas.biceps + ' cm' : '—'}</td>
            </tr>
          </table>
        </div>
        <div style="margin-bottom:12px;">
          <h5>Photo Progress</h5>
          ${photoHtml}
        </div>
        <div style="margin-bottom:12px;">
          <h5>Strength Workout</h5>
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="border:1px solid #bbb; padding:6px;">Exercise</th>
                <th style="border:1px solid #bbb; padding:6px;">Sets</th>
                <th style="border:1px solid #bbb; padding:6px;">Reps</th>
                <th style="border:1px solid #bbb; padding:6px;">Weight</th>
                <th style="border:1px solid #bbb; padding:6px;">Note</th>
              </tr>
            </thead>
            <tbody>
              ${(entry.strength || []).map(s => `
                <tr>
                  <td style="border:1px solid #bbb; padding:6px;">${s.exercise || '—'}</td>
                  <td style="border:1px solid #bbb; padding:6px;">${s.sets || '—'}</td>
                  <td style="border:1px solid #bbb; padding:6px;">${s.reps || '—'}</td>
                  <td style="border:1px solid #bbb; padding:6px;">${s.weight || '—'}</td>
                  <td style="border:1px solid #bbb; padding:6px;">${s.note || ''}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div style="margin-bottom:12px;">
          <h5>Cardio</h5>
          ${(entry.cardio || []).map(c => `
            <div style="padding:8px; border:1px solid #ccc; border-radius:6px; margin-bottom:4px;">
              <div><strong>Activity:</strong> ${c.activity || '—'}</div>
              <div>Time: ${c.time || '—'} min, Distance: ${c.distance || '—'} km, Speed: ${c.avgSpeed || '—'} km/h, Steps: ${c.steps || '—'}</div>
            </div>
          `).join('')}
        </div>
        <div>
          <h5>Reflection / Next Goal</h5>
          <div style="border:1px solid #ccc; padding:8px; border-radius:4px;">${entry.reflection || '—'}</div>
        </div>
        <div style="margin-top:16px; font-size:0.75rem; color:#555;">
          Generated by Smart Training Diary.
        </div>
      `;
      return container;
    }

    // Modal open
    function openEntryModal(entry) {
      const preview = document.getElementById('entryPreview');
      preview.innerHTML = '';
      preview.appendChild(buildEntryHTML(entry));
      document.getElementById('deleteEntryBtn').onclick = () => {
        if (confirm('Delete this entry?')) {
          deleteEntry(entry.id);
          bootstrap.Modal.getInstance(document.getElementById('entryModal')).hide();
        }
      };
      window._currentEntryForPDF = entry;
      new bootstrap.Modal(document.getElementById('entryModal')).show();
    }

    // PDF / print utilities
    async function htmlToPDFAndDownload(element, filename) {
      const { jsPDF } = window.jspdf;
      element.style.position = 'absolute';
      element.style.left = '-9999px';
      document.body.appendChild(element);
      const canvas = await html2canvas(element, { scale: 1.2 });
      document.body.removeChild(element);
      const img = canvas.toDataURL('image/jpeg', 0.9);
      const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
      const pdfWidth = pdf.internal.pageSize.getWidth() - 40;
      const ratio = canvas.height / canvas.width;
      const pdfHeight = pdfWidth * ratio;
      pdf.addImage(img, 'JPEG', 20, 20, pdfWidth, pdfHeight);
      pdf.save(filename);
    }

    async function exportEntryPDF(entry) {
      const el = buildEntryHTML(entry);
      await htmlToPDFAndDownload(el, `Workout_${entry.date}.pdf`);
    }

    async function downloadEntryPDF() {
      if (!window._currentEntryForPDF) return;
      await exportEntryPDF(window._currentEntryForPDF);
    }

    function printEntry() {
      if (!window._currentEntryForPDF) return;
      const win = window.open('', '_blank');
      const content = buildEntryHTML(window._currentEntryForPDF);
      win.document.body.appendChild(content);
      win.document.head.innerHTML = `<title>Print</title><style>body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;padding:20px;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #bbb;padding:6px;}</style>`;
      setTimeout(() => win.print(), 400);
    }

    // Overview strength progression
    function buildOverviewProgressionPage() {
      const entries = loadEntries().sort((a,b)=> new Date(a.savedAt) - new Date(b.savedAt));
      const exerciseHistory = {};
      entries.forEach(e => {
        (e.strength || []).forEach(s => {
          const name = (s.exercise||'').trim();
          if (!name) return;
          const w = parseFloat(s.weight);
          if (isNaN(w)) return;
          if (!exerciseHistory[name]) exerciseHistory[name] = [];
          exerciseHistory[name].push({ weight: w, date: e.date });
        });
      });
      let rows = '';
      Object.entries(exerciseHistory).forEach(([name, list]) => {
        const last3 = list.slice(-3);
        const trend = last3.length >=2 ? (last3[last3.length-1].weight - last3[0].weight) : 0;
        const trendLabel = trend > 0 ? `<span class="progress-up">+${trend.toFixed(1)} kg</span>` :
                           trend < 0 ? `<span class="progress-down">${trend.toFixed(1)} kg</span>` :
                           `<span class="progress-same">0</span>`;
        rows += `
          <tr>
            <td style="border:1px solid #bbb; padding:6px;">${name}</td>
            <td style="border:1px solid #bbb; padding:6px;">${last3.map(o => o.weight.toFixed(1)).join(' → ')}</td>
            <td style="border:1px solid #bbb; padding:6px;">${trendLabel}</td>
          </tr>
        `;
      });
      const container = document.createElement('div');
      container.style.padding = '16px';
      container.style.background = '#fff';
      container.innerHTML = `
        <div>
          <h2>Overview Strength Progression</h2>
          <div><small>Последние 3 значения по каждому упражнению и общий тренд.</small></div>
        </div>
        <table style="width:100%; border-collapse:collapse; margin-top:8px;">
          <thead>
            <tr>
              <th style="border:1px solid #bbb; padding:6px;">Exercise</th>
              <th style="border:1px solid #bbb; padding:6px;">Last 3 Weights</th>
              <th style="border:1px solid #bbb; padding:6px;">Trend</th>
            </tr>
          </thead>
          <tbody>
            ${rows || '<tr><td colspan="3" style="padding:6px; text-align:center;">Недостаточно данных</td></tr>'}
          </tbody>
        </table>
        <div style="margin-top:12px; font-size:0.75rem; color:#555;">Generated overview of all entries.</div>
      `;
      return container;
    }

    // Photo & measurement overview
    function buildPhotoMeasurementOverview() {
      const container = document.createElement('div');
      container.style.padding = '16px';
      container.style.background = '#fff';
      container.innerHTML = `<div><h2>Photo & Measurement Overview</h2>
        <div><small>Сравнение первых/последних фото и ключевых измерений.</small></div></div>`;

      // Weight change
      const measurements = JSON.parse(localStorage.getItem('bodyMeasurements') || '[]');
      if (measurements.length) {
        const first = measurements[0];
        const last = measurements[measurements.length -1];
        container.innerHTML += `
          <div style="margin-top:12px;">
            <h5>Weight change</h5>
            <div>From ${first.date}: ${first.weight || '—'} kg → To ${last.date}: ${last.weight || '—'} kg</div>
          </div>
        `;
      }

      // Photo comparison
      const photos = JSON.parse(localStorage.getItem('progressPhotos') || '[]');
      if (photos.length >= 1) {
        const sorted = photos.slice().sort((a,b)=> new Date(a.date) - new Date(b.date));
        const firstPhoto = sorted[0];
        const lastPhoto = sorted[sorted.length-1];
        container.innerHTML += `
          <div style="margin-top:12px;">
            <h5>Photo comparison</h5>
            <div style="display:flex; gap:16px; flex-wrap:wrap;">
              <div style="flex:1; min-width:180px;">
                <div><strong>${firstPhoto.date}</strong></div>
                <img src="${firstPhoto.src}" style="max-width:100%; border:1px solid #ccc; border-radius:6px;" />
              </div>
              <div style="flex:1; min-width:180px;">
                <div><strong>${lastPhoto.date}</strong></div>
                <img src="${lastPhoto.src}" style="max-width:100%; border:1px solid #ccc; border-radius:6px;" />
              </div>
            </div>
          </div>
        `;
      }
      return container;
    }

    // Export all entries PDF with overview pages
    async function exportAllEntriesPDF() {
      const entries = loadEntries();
      if (!entries.length) {
        alert('No entries to export.');
        return;
      }
      const { jsPDF } = window.jspdf;
      const master = new jsPDF({ unit: 'pt', format: 'a4' });
      const pdfWidth = master.internal.pageSize.getWidth() - 40;

      // 1. Strength overview
      const overviewEl = buildOverviewProgressionPage();
      overviewEl.style.position = 'absolute';
      overviewEl.style.left = '-9999px';
      document.body.appendChild(overviewEl);
      const ovCanvas = await html2canvas(overviewEl, { scale: 1.2 });
      document.body.removeChild(overviewEl);
      const ovImg = ovCanvas.toDataURL('image/jpeg', 0.9);
      const ovRatio = ovCanvas.height / ovCanvas.width;
      const ovHeight = pdfWidth * ovRatio;
      master.addImage(ovImg, 'JPEG', 20, 20, pdfWidth, ovHeight);

      // 2. Photo & measurement overview
      master.addPage();
      const photoMeasEl = buildPhotoMeasurementOverview();
      photoMeasEl.style.position = 'absolute';
      photoMeasEl.style.left = '-9999px';
      document.body.appendChild(photoMeasEl);
      const pmCanvas = await html2canvas(photoMeasEl, { scale: 1.2 });
      document.body.removeChild(photoMeasEl);
      const pmImg = pmCanvas.toDataURL('image/jpeg', 0.9);
      const pmRatio = pmCanvas.height / pmCanvas.width;
      const pmHeight = pdfWidth * pmRatio;
      master.addImage(pmImg, 'JPEG', 20, 20, pdfWidth, pmHeight);

      // 3. Individual entries
      for (let i = 0; i < entries.length; i++) {
        const entry = entries[i];
        master.addPage();
        const el = buildEntryHTML(entry);
        el.style.position = 'absolute';
        el.style.left = '-9999px';
        document.body.appendChild(el);
        const canvas = await html2canvas(el, { scale: 1.2 });
        document.body.removeChild(el);
        const img = canvas.toDataURL('image/jpeg', 0.9);
        const ratio = canvas.height / canvas.width;
        const height = pdfWidth * ratio;
        master.addImage(img, 'JPEG', 20, 20, pdfWidth, height);
      }
      master.save('All_Workouts_with_Progression.pdf');
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      populateExerciseDatalist();
      renderEntriesList();
      document.querySelectorAll('.strength-row').forEach(r => {
        wireExerciseNameField(r);
        attachStrengthRowListeners(r);
      });
      document.querySelectorAll('.cardio-row').forEach(attachCardioRowListeners);
      document.getElementById('trainingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const entry = collectFormEntry();
        entry.jointMobility = document.getElementById('joint').checked;
        entry.strength = [];
        saveEntry(entry);
        renderEntriesList();
        alert('Saved entry.');
        this.reset();
        // reattach for new blank row
        document.querySelectorAll('.strength-row').forEach(r => {
          wireExerciseNameField(r);
          attachStrengthRowListeners(r);
        });
        document.querySelectorAll('.cardio-row').forEach(attachCardioRowListeners);
      });
    });
  </script>
</body>
</html>
